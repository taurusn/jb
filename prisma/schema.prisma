// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  // Support both Vercel's auto-generated vars and custom DATABASE_URL
  // Vercel Supabase integration uses POSTGRES_PRISMA_URL
  url       = env("POSTGRES_PRISMA_URL")
  // Direct connection for migrations (bypasses pooling)
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// ============================================
// USER MODEL (For Employer Authentication)
// ============================================
model User {
  id                              String         @id @default(uuid())
  email                           String         @unique
  passwordHash                    String         @map("password_hash")
  role                            Role           @default(EMPLOYER)

  // Commercial Registration (Required for employers)
  commercialRegistrationNumber    String         @map("commercial_registration_number")
  commercialRegistrationImageUrl  String         @map("commercial_registration_image_url")

  // Account Status (Employer approval workflow)
  status                          EmployerStatus @default(PENDING)

  createdAt                       DateTime       @default(now()) @map("created_at")
  updatedAt                       DateTime       @updatedAt @map("updated_at")

  // Relations
  employerProfile EmployerProfile?
  auditLogs       AuditLog[]

  @@map("users")
}

// ============================================
// EMPLOYER PROFILE MODEL
// ============================================
model EmployerProfile {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  companyName     String   @map("company_name")
  contactPerson   String   @map("contact_person")
  companyWebsite  String?  @map("company_website")
  phone           String
  industry        String?
  companySize     String?  @map("company_size")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  employeeRequests EmployeeRequest[]

  @@map("employer_profiles")
}

// ============================================
// EMPLOYEE APPLICATION MODEL
// ============================================
model EmployeeApplication {
  id                  String   @id @default(uuid())
  fullName            String   @map("full_name")
  phone               String
  email               String?
  city                String
  nationality         String
  skills              String   @db.Text
  experience          String   @db.Text
  resumeUrl           String   @map("resume_url")
  profilePictureUrl   String?  @map("profile_picture_url")
  submittedAt         DateTime @default(now()) @map("submitted_at")

  // Document Information (Required)
  iqamaNumber         String   @map("iqama_number")
  iqamaExpiryDate     DateTime @map("iqama_expiry_date")
  kafeelNumber        String   @map("kafeel_number")

  // Interview Availability
  // Stores JSON array: [{date: "2024-01-15", times: ["09:00", "10:00", "14:00"]}]
  availableTimeSlots  String?  @map("available_time_slots") @db.Text

  // Relations
  employeeRequests    EmployeeRequest[]

  @@map("employee_applications")
}

// ============================================
// EMPLOYEE REQUEST MODEL (Employer demands)
// ============================================
model EmployeeRequest {
  id          String                @id @default(uuid())
  employeeId  String                @map("employee_id")
  employerId  String                @map("employer_id")
  status      EmployeeRequestStatus @default(PENDING)
  notes       String?               @db.Text
  requestedAt DateTime              @default(now()) @map("requested_at")
  updatedAt   DateTime              @updatedAt @map("updated_at")

  // Interview Meeting Details
  meetingLink     String?   @map("meeting_link")
  meetingDate     DateTime? @map("meeting_date")
  meetingDuration Int?      @map("meeting_duration") // in minutes (30, 45, 60)
  meetingEndsAt   DateTime? @map("meeting_ends_at") // Auto-calculated: meetingDate + duration

  // Admin Notes (JSON array of notes with timestamps)
  adminNotes      String?   @map("admin_notes") @db.Text

  // Relations
  employee    EmployeeApplication   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employer    EmployerProfile       @relation(fields: [employerId], references: [id], onDelete: Cascade)

  // Unique constraint: prevents duplicate requests
  @@unique([employeeId, employerId])
  @@map("employee_requests")
}

// ============================================
// AUDIT LOG MODEL (For Admin Activity Tracking)
// ============================================
model AuditLog {
  id         String   @id @default(uuid())
  adminId    String   @map("admin_id")
  action     String   // "DELETE_CANDIDATE", "UPDATE_REQUEST_STATUS", etc.
  entityType String   @map("entity_type") // "CANDIDATE", "EMPLOYER", "REQUEST", "SETTINGS"
  entityId   String   @map("entity_id")
  details    String?  @db.Text // JSON string with action details
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  admin      User     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

// ============================================
// PLATFORM SETTINGS MODEL
// ============================================
model PlatformSettings {
  id                    String   @id @default(uuid())
  maintenanceMode       Boolean  @default(false) @map("maintenance_mode")
  allowNewRegistrations Boolean  @default(true) @map("allow_new_registrations")
  allowNewApplications  Boolean  @default(true) @map("allow_new_applications")
  platformName          String   @default("Job Platform") @map("platform_name")
  supportEmail          String?  @map("support_email")
  supportPhone          String?  @map("support_phone")
  updatedAt             DateTime @updatedAt @map("updated_at")
  updatedBy             String?  @map("updated_by") // Admin user ID

  @@map("platform_settings")
}

// ============================================
// ENUMS
// ============================================
enum Role {
  EMPLOYER
  ADMIN
}

enum EmployerStatus {
  PENDING   // Awaiting admin approval
  APPROVED  // Can login and use platform
  REJECTED  // Application rejected
}

enum EmployeeRequestStatus {
  PENDING
  APPROVED
  REJECTED
}
